---
layout: post
title:  "Проблема на dlink во время грозы"
date:   2011-10-27 00:46:46 +0400
categories: dlink
tags: dlink
---

# Groza


```
 Unicast RX            15 743 78 447                    24          
 Multicast RX          4592815                       0           
 Broadcast RX          2 496 305                       0
```

```
config traffic control 2:1-2:25 broadcast enable multicast enable unicast disable action drop threshold 545 countdown 5 time_interval 5  
```

Пофиксили в 
1.52.B007


 средняя загрузка CPU должна быть 20-40%. 
Попробую уменьшить treshhold до 1000. Может выявлю проблему на конкретном порту. Сотрудники D-Link молчат как партизаны

А коммутатору становится плохо уже после 100 фр/с.

ЗЫ: Если трафик, как на моем скриншоте выше, то 64000 фр/c - это 22.7Мегабайта/c. Вы можете себе представить такой Broadcast трафик?

60pps для multicast и broadcast трафика со стороны клиента - это потолок
На DES-3010G traffic control threshold выставлен в 64Kbps (меньше он не умеет)
На DGS-3100-24TG traffic control threshold выставлен в 3500 (меньше он не умеет)
На DES-3526 я не помню 


около 70 p/sec в течении, например 15 мину


port_security
от шторма хорошо помогает.


Threshold Вам нужно понижать для броадкаста до минимальных значений, то есть 64-х.
 При использовании режима shutdown (как у Вас) это будет 64 пакета в секунду, в режиме drop - 64 кбит/c. 
Countdown в режиме shutdown также нужно задавать, чтобы отключать порт, минимальное значение - 5 минут.




Я осознанно поставил countdown disable - у нас коммутаторы доступа находятся в кольце между двумя коммутаторами районной агрегации (DGS-3627G), и вот на этих 3627-х trafic control с одной стороны настроен в shutdown mode (с блокировкой порта без автоматического восстановления), а с другой в drop mode c threshold d 130 Мегабит/с.
Т.е. меня устраивает, что бы после возникновения шторма порт гасился на всегда и его нужно было бы руками поднимать.
Я просто хотел услышать рекомендации по threshold-у а-ля "бест практикс" - т.е. какие наиболее общеупотребительные значения люди пользуют.

p.s. что бы не заводить новую тему задам вопрос здесь, так как возник он в процессе обдумывания этой темы:
для DGS-3627G будьте любезны опишите пожалуйста все типы трафика при коммутации(маршрутизации) которых может значительно нагружаться CPU коммутатора.

p.s.s. так же хотелось бы уточнить, что коммутатор подразумевает под юникастным и мультикастным штормом (в рамках функции trafic control)?

p.s.s.s. Приведенные мною выше Stack Trace как нибудь помогли? - Не могли бы вы прокомментировать что они обозначают, т.е. в какой части программного кода вылазит эта ошибка?


Если речь идет о коммутаторах уровня агрегации, то значения threshold подбираются эмпирически исходя из примерного количества клиентов и по результатам мониторинга количества трафика на портах. В плане работы механизма у Вас все верно написано, но учтите, что под юникастом тут понимается DFL (Destination Lookup Failure), то есть трафик для которого МАС-адрес назначения не может быть найден в FDB.
Что касается того, какой трафик попадает на CPU: сюда входит весь трафик предназначенный непосредственно IP-интерфейсам коммутатора, броадкаст и мультикаст во вланах, где есть IP-интерфейсы, также ресурсы CPU задействуются в случае логирования и использования определенного функционала, такого как например DHCP Relay, DHCP Snooping, сбор статистики по SNMP, отсылка трапов и т.д.