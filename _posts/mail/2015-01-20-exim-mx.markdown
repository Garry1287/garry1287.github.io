---
layout: post
title:  "exim-mx"
date:   2015-01-20 16:07:21 +0300
categories: mail
tags: mail
---

# exim-mx



Для этого прописываем в DNS еще одну MX запись (первая указывает на основной почтовик клиента, вторая - на наш сервер).

Что дальше сделать? Настройка должна быть доступна для пользователя...
В идеале - принимать почту и перенаправлять дальше на основной почтовик.


Вручную это настраивается
[http://www.lissyara.su/articles/free...il/exim_relay/](http://www.lissyara.su/articles/free...il/exim_relay/)
вам нужно только relay_domains настроить и список этих доменов, exim на secondary mx примет почту и будет держать ее в спуле пытаясь отправлять на primary mx

Во FreeBSD скорее всего достаточно только строку поправить

Код:

domainlist relay_to_domains = lsearch;/usr/local/etc/exim/domains : domain1.ru : domain2.ru






imapsync
fetchmail

Есть в портках такая программулька, называется imapsync. Я уже лет 10
точно, а может и больше, пользуюсь ей при переездах.

Поступаю обычно где-то так:
- Заворачиваю всю почту на новый сервер. Старый при этом ещё работает,
но почта на него уже не должна попадать.
- Делаю так, чтобы юзеры ходили за почтой на новый сервер.
- Запускаю перенос почты со старого сервера на новый - то бишь,
программульку imapsync с параметрами на каждый ящик. Можно
последовательно, можно параллельно.

Схема очень упрощённая, нюансы у всех свои. Где-то там должна быть
настройка нового сервера, MX записей, рассылка предупреждения юзерам
(типа, "не пугайтесь, новая почта тут, старая не потерялась, ожидается в
течение суток, если срочно надо ходить туда-то"). Получается с нулевым
простоем.

зачем извращения с ngnix, когда данный функционал есть у dovecot2 уже давно. но там есть нюанс что много ограничений.
я когда переезжал дважды на одном сервере использовал тупо rsync, самый простой и дешевый способ по ресурсам. без ковыряния imap-proxy, imapsync и прочих SAN



Пропущен вариант с использованием дополнительного элемента — ретранслятора почты.
На нем и рисуется правила форвардинга почты, для отдельных ящиков, на новый почтовик или на старый.
Он же и выступаем единственным MX для домена.
После окончательной миграции на новый почтовик — меняются MX на новый сервер, а ретранслятор понижается до backup MX.
Для пущей надежности можно использовать два хоста-ретранслятора, один из них сугубо backup MX.



Брррр.
Вы взяли две непростые почтовые системы — gmail и m$ exchange, намеренно не использовали backup MX (как без этого в продакшене, я не понимаю),
 добавили лишние сущности в виде поддомена и отправки СС.

Создание дочернего поддомена еще больше усложняет.
Покопайтесь в своих почтовых системах, и разберитесь, как выставить приоритеты доставки:
1) если есть почтовый ящик, то слать почту туда
2) если домен локальный, но нет почтового ящика — то слать на ретранслятор
3) если домен нелокальный, то или отлуп или отправка от себя.

Настройка ретранслятора займет 5-15 минут.
1) купить или развернуть линукс|FreeBSD
2) поставить свежий sendmail
3) скачать конфиги со своей библиотеки (или нагуглить)
4) подправить под текущую задачу
5) подправить MX записи у домена

А если бы взяли и почитали старую книгу Немет — «UNIX. Руководство системного администратора», то б узнали, как мигрировать большие почтовые системы с
 с минимумом простоя. Эти рецепты еще с середины 90-х!