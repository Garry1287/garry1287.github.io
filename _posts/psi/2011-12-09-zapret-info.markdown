---
layout: post
title:  "zapret-info"
date:   2011-12-09 00:04:15 +0400
categories: PSI
tags: PSI
---

# zapret-info
Памятка по работе с ЭЦП для РОСКОМНАДЗОРА:
0) ВНИМАНИЕ! Рекомендуется для упрощения работы при экспорте использовать пароль 1234567890;
1) необходимо получить сертификат и ключ у одного из аккредитованных УЦ (сейчас у ЦентрИнформ);
2) в УЦ запишут ключ и сертификат на носитель eToken;
3) для работы с носителем eToken нужна машина с Windows и без установленного ПО КриптоПро CSP;
4) так же понадобится  программа P12FromGostCSP;
5) после установки КриптоПро вставляем носитель eToken в ПК, при помощи КриптоПро импортируем ключ в реестр со всеми возможными параметрами (сохранение закрытого ключа и проч.);
6) при помощи программы P12FromGostCSP вытаскиваем ключ из реестра в формате PFX (PKCS#12);
7) Шиндовс больше не нужен, переходим в OpenSuse (или лубую другую удобную Unix систему);
8) создаем каталог для удобства дальнейшей работы и помещаем полученный файл p12.pfx в этот каталог;
9) добавляем в конфиг OpenSSL (/etc/ssl/openssl.cnf):
до начала секций:
openssl_conf = openssl_def
в конце файла:
[openssl_def]
engines=engine_section

[engine_section]
gost=gost_section

[gost_section]
engine_id=gost
default_algorithms=ALL;
10) переходим в каталог и выполняем следующие команды:
openssl pkcs12 -in /path/p12.pfx -out /path/mycert.crt -nodes
и
openssl pkcs12 -in /path/p12.pfx -nocerts -out /path/mykey.key
11) копируем полученные файлы в директорию /root/zapret-info/ на rock.sc.ru с заменой.
12) Забываем об этом геморрое на год!












Меня попросили передать Вам информацию по блокировке сайтов.

Сразу оговорюсь, что у Нас блокировка ресурсов происходит на DNS сервере.

Ниже, я вкратце опишу принцип, по которому у Нас блокируются запрещенные Роскомнадзором ресурсы.

1) Вам понадобится ЭЦП, выданная аккредитованной организацией.
2) Необходимо извлечь с носителя информацию, чтобы ключ подписи представлял из себя 2 файла (*.cert - файл сертификата ключа и и собственно *.key - сам ключ).
3) Далее опишу принцип взаимодействия файлов:
    3.1) zapret-info.sh - исполняемый скрипт, который, собственно управляет всем процессом выгрузки информации с сайта Роскомнадзор и созданием правил. Вся логика работы заключается в этом скрипте;
    3.2) zapret-info.zones - собственно файл зон для блокировки на dns-сервере;
    3.3) dump.xml, out out_old, out_tmp.txt - промежуточные файлы, которые создаются и изменяются в процессе работы скрипта;
    3.4) python_scripts/zapretinfo.py и python_scripts/zapret_checker.py - связка из скриптов, которые выкачивают с сайта Роскомназора архив и проверяют целостность файлов;
    3.5) python_scripts/parse.py - скрипт, который вычленяет из файла, полученного от Роскомназора, имена доменов, фильтрует повторения и создает список доменов для блокировки.

И так, теперь опишу логику работы:
1. При старте скрипта создается файл запроса (в Нашем случае 'promsvyaz.xml'), со структурой xml (описание по созданию запроса есть на сайте Роскомнадзора)
2. Файл запроса подписывается при помощи ключа и сертификата;
3. Подписанный файл запроса отправляется в Роскомнадзор;
4. Если запрос принят, то скрипт ожидает ответа от ресурса. При получении ответа, скрипт продолжает работу. В виде ответа ресурс Роскомнадзор возвращает архив с файлом dump.xml;
5. Дальше архив распаковывается, файл парсится, создается файл зон и помещается на наш Named  Server;

Попутно, у Нас все действия логируются в файл, чтобы можно было отследить изменения.

Вот собственно и всё.

На последок, могу дать несколько ссылок, которые могут быть полезными:
[http://habrahabr.ru/qa/27711/](http://habrahabr.ru/qa/27711/) - Получение реестра запрещенных сайтов
[http://habrahabr.ru/sandbox/51575/](http://habrahabr.ru/sandbox/51575/) - Работаем с реестром запрещенных сайтов
[http://habrahabr.ru/company/netangels/blog/158891/](http://habrahabr.ru/company/netangels/blog/158891/) - Как мы получали доступ к базе реестра запрещенных ресурсов
Собственно с этих ресурсов мы и черпали всю информацию.







dump.xml - полученный от роскомнадзра список всех заблокированных ресурсов
out_tmp.txt - полученный с помощью скрипта parse.py списко доменов без сетей и ip адресов
blocked.list.actual  - этот же список, но без повторений (могут быть url)
blocked.list.old - это список из предыдущего запуска скрипта

exception.blocked.list.actual - список с исключениями

blocked.list.filtered  - список, у которого на конце не удалены спец.символы, короче не подходящие нам для генерации fake зон домены

'[[:lower:]]\W+$'
маленькая буква (буквы) за которыми один или несколько не букв или цифр


exception.blocked.list.actual  список с исключениями
exception.blocked.list.old  -  список с исключениями от старого запуска
exception.list  -  список сайтов придуманный Серёжой или нами


















dump.xml
<content id="108154" includeTime="2014-10-18T16:08:51" urgencyType="1" entryType="3" hash="4DE183163069EAEF83C5907D9F36D855">
<decision date="2014-03-13" number="Исорг-27/3-3420-14/" org="Генпрокуратура"/>
    <url><![CDATA[[http://mirror58.graniru.info/](http://mirror58.graniru.info/)]]></url>
    <domain><![CDATA[mirror58.graniru.info]]></domain>
    <ip>23.253.135.208</ip>
</content>

<content id="108155" includeTime="2014-10-18T22:45:14" urgencyType="1" entryType="3" hash="C33F5ABFEEE9BAE5C348B7F9AA5A1CE1">
<decision date="2014-10-17" number="27-27-2014/Ид3496-14" org="Генпрокуратура"/>
    <url><![CDATA[[http://regularis-news.livejournal.com/955123.html](http://regularis-news.livejournal.com/955123.html)]]></url>
    <domain><![CDATA[regularis-news.livejournal.com]]></domain>
    <ip>208.93.0.190</ip>
</content>


<content id="40455" includeTime="2013-08-21T12:26:02" entryType="2" blockType="domain" hash="1091F6271C89EDFC40356F86ABA3D766">
<decision date="2013-08-12" number="определение о предварительном обеспечении по заявлению № 2и-0013/2013" org="Мосгорсуд"/>
    <domain>opensharing.org</domain>
    <ip>46.148.16.146</ip>
</content>


<content id="44350" includeTime="2013-09-17T19:57:00" entryType="2" blockType="domain" hash="BDA0DF9E1F162C99CA98DAE8AF049F5E">
<decision date="2013-09-04" number="определение о предварительном обеспечении по заявлению № 2и-0049/2013" org="Мосгорсуд"/>
   <domain>hotbase.org</domain>
   <ip>172.99.89.202</ip>
</content>


<content id="68716" includeTime="2014-02-18T16:32:25" urgencyType="1" entryType="3" blockType="domain" hash="E36DFBE55099E014044D2362758B5859">
<decision date="2014-02-17" number="27-27-2014/Ид515-14" org="Генпрокуратура"/>
   <domain>www.islamdin.com</domain>
   <ip>193.219.6.131</ip>
   <ip>64.74.223.38</ip>
</content>


<content id="69438" includeTime="2014-02-24T16:24:57" urgencyType="1" entryType="3" blockType="domain" hash="B5A580F7530606571CC291AB8D26ABAC">
<decision date="2014-02-24" number="27-27-2014/Ид514-14" org="Генпрокуратура"/>
    <domain>hunafa.com</domain>
    <ip>72.8.190.48</ip>
    <ip>72.8.190.47</ip>
    <ip>69.197.12.141</ip>
    <ip>69.197.12.185</ip>
    <ip>198.52.250.120</ip>
    <ip>167.114.29.195</ip>
</content>



<content id="88522" includeTime="2014-07-23T11:39:17" entryType="1" hash="7EF59BBF0C3E6ABA54CEA94F51C25E4E">
<decision date="2014-07-09" number="2-3046/14" org="суд"/>
    <url>[https://www.ex.ua/get/111836119](https://www.ex.ua/get/111836119)</url>
    <domain>www.ex.ua</domain>
    <ip>77.120.115.178</ip>
     <ip>77.120.115.184</ip>
</conten






     

Если 'blockType' ==ip, то заносим в отдельный файл и блочим ip (ip route)

if node4.getAttribute('blockType')==domain, то взять из него элемент domain и записать в один файл
если пуст, то блокировать как обычно
Блокировать поддомены по звёздочке DNS, формировать новую зону для блокировки stubdomain

 'blockType' = None, Null, то блокируем как обычно


 