SNMP trap fallback				History
			SNMP trap SNMP athentication failure




CDE-C3.sc.int: SNMP trap fallback
09/10/2019 01:59:49 AM	09/10/2019 01:59:43 AM	

01:59:43 2019/09/10  .1.3.6.1.4.1.9.0.1 Normal "General event" 192.168.121.63 - 5




######FORMAT Link down on interface $1.  Admin state: $2.  Operational state: $3
#EXEC qpage -f TRAP notifygroup1 "Link down on interface $1.  Admin state: $2.  Operational state: $3"
######SDESC
######A linkDown trap signifies that the SNMP entity, acting in
######an agent role, has detected that the ifOperStatus object for
######one of its communication links is about to enter the down
######state from some other state (but not from the notPresent
######state).  This other state is indicated by the included value
######of ifOperStatus.




09/11/2019 05:51:34 PM	09/11/2019 05:51:29 PM	

17:51:29 2019/09/11  .1.3.6.1.6.3.1.1.5.5 Normal "General event" 192.168.121.63 - 92.118.160.1




{CDE-C3.sc.int:snmptrap.fallback.nodata(300)}=0




vivey-48@mail.ru





17:59:34 2019/09/09  .1.3.6.1.6.3.1.1.5.4 Normal "Status Events" 192.168.121.63 - Link up on interface 1.  Admin state: FastEthernet0/0.  Operational state: ethernetCsmacd
17:59:45 2019/09/09  .1.3.6.1.6.3.1.1.5.3 Normal "Status Events" 192.168.121.63 - Link down on interface 1.  Admin state: FastEthernet0/0.  Operational state: ethernetCsmacd





Create "Template SNMP trap fallback"

Create "SNMP trap fallback" template (https://www.zabbix.com/documentation/2.2/manual/config/templates/template#creating_a_template) and "SNMP trap fallback" item:

    Name: SNMP trap fallback
    Type: SNMP trap
    Key: snmptrap.fallback
    Type of information: Log

This item will collect all unmatched traps. Create trigger which will inform administrator about new unmatched traps:

    Name: Unmatched SNMP trap received from {HOST.NAME}
    Expression: {Template SNMP trap fallback:snmptrap.fallback.nodata(300)}=0






{CDE-C3.sc.int:ifOperStatus[GigabitEthernet0/0].change()}<>0



{Template SNMP traps:snmptrap["cpqRackPowerSubsystem(NotRedundant|LineVoltageProblem|OverloadCondition)"].str("OverloadCondition")}=1&{Template SNMP traps:snmptrap["cpqRackPowerSubsystem(NotRedundant|LineVoltageProblem|OverloadCondition)"].nodata(5m)}=0


{CDE-C3.sc.int:snmptrap[".1.3.6.1.6.3.1.1.5.5"].str(SNMP athentication failure)}=1 and {CDE-C3.sc.int:snmptrap[".1.3.6.1.6.3.1.1.5.5"].nodata(5m)}=0



Имя триггера: {HOST.HOST} Loop on port 1
Выражение проблемы: {DES-1228ME:snmptrap.fallback.regexp(SNMPv2-MIB::snmpTrapOID.0 type=6 value=OID: SNMPv2-SMI::enterprises.171.11.116.2.2.20.0.3,#1)}=1 and {DES-1228ME:snmptrap.fallback.regexp(SNMPv2-SMI::enterprises.171.11.116.2.2.21.2.1.1.1.1 type=2 value=INTEGER: 1,#1)}=1
Выражение восстановления: {DES-1228ME:snmptrap.fallback.regexp(SNMPv2-MIB::snmpTrapOID.0 type=6 value=OID: SNMPv2-SMI::enterprises.171.11.116.2.2.20.0.4,#1)}=1 and {DES-1228ME:snmptrap.fallback.regexp(SNMPv2-SMI::enterprises.171.11.116.2.2.21.2.1.1.1.1 type=2 value=INTEGER: 1,#1)}=1





 {%device_name%:snmptrap[Backup Exec Job Canceled].regexp(ubuntu-14-work-Full)}>0


(({TRIGGER.VALUE}=0 and {Int:snmptrap["(linkUp|linkDown)"].str(linkDown)}=1) or 
({TRIGGER.VALUE}=0 and {Int oper:ifOperStatus[{#IFDESCR}].last()}<>1)) or 
(({TRIGGER.VALUE}=1 and {Int:snmptrap["(linkUp|linkDown)"].str(linkDown)}<>1) or 
({TRIGGER.VALUE}=1 and {Int oper:ifOperStatus[{#IFDESCR}].last()}=1))



{Testhost:snmptrap["XCB-SNMP-MIB::xcbLoginFailure"].count(2m)}>5
{Testhost:snmptrap["XCB-SNMP-MIB::xcbLoginFailure"].count(2m,username)}>5



{Template OS Windows:Compare.Files.nodata(5m)}=1 
{Template OS Windows:Compare.Files.str("^$",5m)}=1



Имя:          {HOST.NAME} недоступен!
Выражение:    {Template SNMP Device:sysUpTime.nodata(180)}=1




({TRIGGER.VALUE}=0 & {Template LinkDown:snmptrap[Link down].str(" 1 port")}=1) | ({TRIGGER.VALUE}=1 & {Template LinkDown:snmptrap[Link Up].str(" 1 port")}#1)


{Oracle DB1:system.cpu.load.min(5m)} > 2
За последние 5 минут не было значения загрузки cpu больше 2, если было(ИСТИНА), то триггер срабатывает



Предлагаю средствами zabbix протестировать триггеры, переходишь в режим «expression constructor» и тестируешь до тех пор, пока не познаешь дзен.


{Template LinkDown:snmptrap.fallback.str(Link down)}=1








{messaging-history:web.test.fail[Tomcat-checker1].count(#3,0,ne)}>2

Данный триггер подсчитывает какое количество раз за последние 3 запуска значение элемента данных “web-test-messaging-history-Tomcat-checker” не равнялось 0, и если полученное число больше 2, то триггер срабатывает.

помним, что сценарий запускается раз в минуту

Другими словами: Если из трех идущих подряд проверок хотя бы одна была успешной, то считаем, что сайт в порядке

Или еще более другими словами :) Если сайт недоступен в течение трех минут подряд – то считаем что он упал.




https://www.opennet.ru/openforum/vsluhforumID13/907.html







Например, вы можете использовать триггер, подобный этому, чтобы проверить, что доступная память составляет менее 10% от общего числа:

{Template OS Linux:vm.memory.size[available].max(#3)} <
    0.1 * {Template OS Linux:vm.memory.size[total].last()}

В электронной почте действия вы можете ссылаться на имена, ключи и значения элементов:

Item values:

1. {ITEM.NAME1} ({HOST.NAME1}:{ITEM.KEY1}): {ITEM.VALUE1}
2. {ITEM.NAME2} ({HOST.NAME2}:{ITEM.KEY2}): {ITEM.VALUE2}
3. {ITEM.NAME3} ({HOST.NAME3}:{ITEM.KEY3}): {ITEM.VALUE3}

В приведенном выше примере {ITEM.KEY1} относится к vm.memory.size[available] а {ITEM.KEY2} относится к vm.memory.size[total]. Аналогично для других макросов. {ITEM.KEY3} будет расширяться до *UNKNOWN*, потому что в триггерном выражении нет третьего элемента.

Такой формат электронной почты поставляется с Zabbix 2.2 и Zabbix 2.4 по умолчанию.



{test:tcp,10050.min(300)}=0"
If you use min, a single value is enough to raise the trigger.  (По крайней мере одно из значений должно быть равно нулю)
If you want ALL values to be 0, it need to use max function.  (Все полученные значения должны быть равны 0)


Максимальное значение за указанный период вычисления. 
Минимальное значение за указанный период вычисления. 









 Шаблон проверки доступности по ICMP
Template ping_loss_60s:
   Items:

    loss (Type: Simple check, Key: icmppingloss[,12,60,], Data type: Decimal, Units: %, Update interval (in sec): 60, Description: посылаю 12 пакетов с интервалом 60ms (размер немного больше среднего пинга), по-умолчанию задержка на ответ 500ms - итого все укладывается так как весь интервал 60s=60000ms)

    pingsec (Type: Simple check, Key: icmppingsec[], Data type: Numeric(float), Units: ms, Use custom multiplier: 1000, Update interval (in sec): 60)

   Trigers:

    loss_connection (Expression: {ping_loss_60s:icmppingsec[].count(15m,0)}>10, Description: недоступен более 10 раз за последние 15 минут, Severity: Warning)   

   Graphs:

    loss (Graph type: W:900, H:200, Normal, Show legend, Show working time, Y axis MIN value: Fixed:0.01, Y axis MAX value: Fixed:100, Items: loss, Function: all, Drawstyle: Gradient line, Colour: red)
    pingsec (Graph type: W:900, H:200, Normal, Show legend, Show working time, Y axis MIN value: Fixed:0.01, Y axis MAX value: Calculated, Items: pingsec, Function: all, Drawstyle: Gradient line, Colour: green)

Хотя можно стандартными шаблонами пользоваться, почти одно и тоже.






nodata
Проверка, отсутствия полученных данных. 

Результат:
1 - если нет полученных данных за указанный период времени
0 - в противном случае


 Нет данных за последние 3 минуты

Используется функцию nodata():

{zabbix.zabbix.com:tick.nodata(3m)}=1

Для того, чтобы этот триггер заработал, элемент данных ‘tick’ должен быть задан как элемент данных типа Zabbix траппер. Узел сети должен периодически отправлять данные этому элементу данных, используя zabbix_sender. Если не было получено данных за последние 180 секунд, значением триггера станет ПРОБЛЕМА.

Обратие внимание, что 'nodata' можно использовать с любым типом элементов данных



















Пример 2

Очень мало свободного места на диске

Проблема: если меньше 10ГБ за последние 5 минут

Восстановление: если больше 40ГБ за последние 10 минут

({TRIGGER.VALUE}=0 and {server:vfs.fs.size[/,free].max(5m)}<10G) or 
({TRIGGER.VALUE}=1 and {server:vfs.fs.size[/,free].min(10m)}<40G)

Обратите внимание, используется макрос {TRIGGER.VALUE}. Он возвращает текущее состояние триггера.






//logic_expr ? true_value : false_value
(logic_expr) * (true_value) + (not logic_expr) * (false_value)

//max of two items
(item1 > item2) * item1 + (item1 <= item2) * item2

//number of items over threshold
(item1 > threshold) + (item2 > threshold) + ... + (itemN > threshold)


Если не получает ответ (0), то срабатывает триггер
{A test host:agent.ping.nodata(300)=1}





https://habr.com/ru/company/oleg-bunin/blog/320678/



.1.3.6.1.6.3.1.1.5.4  -up

.1.3.6.1.6.3.1.1.5.3  -down



{SNMP Trap failback:snmptrap.fallback.nodata(300)}=0
Триггер сработает, когда получить сообщене



Если данные приходят, то ложь, а в итоге ИСТИНА и
Если данные не приходят, то истина и в итоге ЛОЖЬ(0) и триггер не сработает


{Template SNMP traps:snmptrap["cpqRackPowerSubsystem(NotRedundant|LineVoltageProblem|OverloadCondition)"].str("OverloadCondition")}=1&{Template SNMP traps:snmptrap["cpqRackPowerSubsystem(NotRedundant|LineVoltageProblem|OverloadCondition)"].nodata(5m)}=0


Надо чтобы триггер попал в проблему и вернулся когда линк поднялся


{Template SNMP Interfaces:snmptrap["(.1.3.6.1.6.3.1.1.5.4|.1.3.6.1.6.3.1.1.5.3)"].str(Linkdown)}=1



({TRIGGER.VALUE}=0 and {SNMP Trap failback:snmptrap[".1.3.6.1.6.3.1.1.5.3"].str(Linkdown)}=1) or 
({TRIGGER.VALUE}=1 and {SNMP Trap failback:snmptrap[".1.3.6.1.6.3.1.1.5.4"].str(Linkup)}=0)






Create items for linkUp/linkDown traps with LLD

Let's create item prototype for linkUp/linkDown traps. I'll use "Network interfaces" discovery rule from default "Template SNMP Interfaces" template. Add item prototype (https://www.zabbix.com/documentation/2.2/manual/discovery/low_level_discovery).

Example 3

  Name: Link status trap for {#SNMPVALUE}
  Type: SNMP trap
  Key: snmptrap["(IF-MIB::linkDown|IF-MIB::linkUp)(.|[[:space:]])*{#SNMPVALUE}"]
  Type of information: Log

Create triggers for linkUp/linkDown traps with LLD

Create trigger prototype for linkUp/linkDown traps (from "Example 3"):

  Name: Interface {#SNMPVALUE} on {HOST.NAME} is down
  Expression: {Template SNMP Interfaces:snmptrap["(IF-MIB::linkDown|IF-MIB::linkUp)(.|[[:space:]])*{#SNMPVALUE}"].str(linkDown)}=1

this trigger goes into the Problem state if trap received and contains the text string "linkDown". The trigger will be returned to the Ok state, if received trap with "linkUp" text.

Link "Template SNMP traps" and "Template SNMP Device" (which include our LLD rule for linkUp/linkDown traps) templates to hosts and check result. 




Не работатет, так как первое выражение будет истинным, так как в логе в записях с snmptrap[".1.3.6.1.6.3.1.1.5.3"] всегда будет linkdown
{Template SNMP Interfaces:snmptrap[".1.3.6.1.6.3.1.1.5.3"].str(linkdown)}=1 or {Template SNMP Interfaces:snmptrap[".1.3.6.1.6.3.1.1.5.4"].str(linkup)}=0


Частое срабатывание триггера
https://it-pilot.ru/2013/06/11/zabbix/
https://ixnfo.com/primeryi-triggerov-dlya-zabbix.html







шаблон проверяет доступность хоста в течение 120 секунд 3 раза , если хост не доступен срабатывает триггер
итем
триггер
{pinger:icmpping[].count(120,0)}>3




Назначьте в Action оповещение по e-mail на шаг N, где N = желаемое время / длительность шага (Default operation step duration).





https://www.zabbix.com/forum/in-russian/46495-%D0%A0%D0%B0%D0%B7%D0%BD%D0%BE%D0%B5-%D0%B2%D1%80%D0%B5%D0%BC%D1%8F-%D1%81%D1%80%D0%B0%D0%B1%D0%B0%D1%82%D1%8B%D0%B2%D0%B0%D0%BD%D0%B8%D1%8F-%D1%82%D1%80%D0%B8%D0%B3%D0%B5%D1%80%D0%B0-%D0%B8-%D0%BE%D0%BF%D0%BE%D0%B2













{availability:icmpping[].last(0)}=0

Советую не использовать ключ status, плохо он работает.
Для серверов с Zabbix_agent я использую
{Host:agent.ping.nodata(150)}=1
Для всех остальных
{Host:icmpping.max(90)}=0 


Добавлен триггер "No Data" - {HOSTNAME:sysName.0.nodata(65)}=1






А документацию почитать?
{host:agent.ping.nodata(150)}=1
Хост с Zabbix Agent недоступен 150 секунд.

{host:icmpping.max(90)}=0
за последние 90 секунд все ping не прошли.

Интервалы опросов задаются в Item agent.ping и icmpping соответственно.
Т.к. для icmpping запускается программа с ключами /usr/sbin/fping -q -C3, т.е. один опрос icmpping это отправка 3 пакетов.
Т.е. если опрос icmpping идёт каждые 30 секунд, то триггер вернёт 0, если за 3 попытки по 3 icmp пакета, т.е. на все 9 icmp пакетов не было получено ответа. Если будет хотя бы один ответ, то значение триггера будет 1. 




Если проверка каждые 30 секунд идет, то последние 3 значения - это 1 минута (получается если в течение 1 минуты пропали все пинги, то триггер сработает
{Template ICMP Ping:icmpping.max(#3)}=0












маршрутизаторы должны проверяться в течении 2 минут, а для рабочих станций это время может быть увеличено до 5 минут. В этом случае простая перезагрузка рабочей станции, не зарегистрируется в системе мониторинга как проблема.

А проверку доступности свичей можно увеличить до 10 мин



если ты хочешь поставить условие "потери в течении 180 секунд", то это означает что ПРИ КАЖДОЙ проверке у нас есть потери, а это функция min() 





Назначьте в Action оповещение по e-mail на шаг N, где N = желаемое время / длительность шага (Default operation step duration). 




({prodix_freebsd:status.last(0)}=2)&({prodix_freeb sd:status.nodata(300)}=1)


Я обычно использую
Если ping не прошёл 4 раза подряд
{ping:icmpping[{HOST.CONN},4].max(#4)}=0
Если не было ни одного успешного ping 300 сек ( 5 минут)
{ping:icmpping[{HOST.CONN},4].max(300)}=0 







Ping loss is too high on {HOST.NAME}  Зависит от Template ICMP Ping:            {HOST.NAME} is unavailable by ICMP{Template ICMP Ping:icmppingloss.min(5m)}>20
Response time is too high on {HOST.NAME}                                                     {Template ICMP Ping:icmppingsec.avg(5m)}>0.15
{HOST.NAME} is unavailable by ICMP                                                                  {Template ICMP Ping:icmpping.max(#3)}=0



Пример 7

Сервер недоступен

{zabbix.zabbix.com:icmpping.count(30m,0)}>5

Это выражение будет истинным, если узел сети “zabbix.zabbix.com“ недоступен более 5 раз за последние 30 минут.


Если в последние 3 значения будут равны нулю(пинг не проходит), то триггер срабатывает
Если триггер активен 

({TRIGGER.VALUE}=0 and {Template SNMP Mikrotik:icmpping[,4].max(#3)}=0) or
({TRIGGER.VALUE}=1 and {Template SNMP Mikrotik:icmpping[,4].min(#3)}=0)

должна быть ложь для отключения триггера, верхнее выражение ложно, чтобы нижнее было ложным - правое выражение должно быть ложным
Если за последние 3 значения по крайней мере одно равно (пинг не прошел), то выражение истина, а нам нужна ложь. Это значить пинг должне проходить, тогда триггер отключиться.




Вот отличная статья о триггере на падение интерфейса

{Template2 SNMP Device:ifOperStatus[{#SNMPVALUE}].avg(3600)}<2 and {Template2 SNMP Device:ifOperStatus[{#SNMPVALUE}].last(#1)}=2 and {Template2 SNMP Device:ifAlias[{#SNMPVALUE}].str(this_does_not_exist)}=0

http://sysnet-adventures.blogspot.com/2014/04/zabbix-create-production-network.html
http://sysnet-adventures.blogspot.com/2014/04/zabbix-display-network-interface.html


Всё отлично работает



Как убрать сетевые интерфейсы
https://shurshun.ru/zabbix-ubiraem-lishnie-setevyie-interfeysyi/













trigger ping 
({TRIGGER.VALUE}=0 and {YOURHOSTorTEMPLATE:icmpping.max(600)}=0)



Missed 1/3 Pings --> ({Tolerant Ping:icmpping.avg(#3)}<1) and ({Tolerant Ping:icmpping.avg(#3)}>0.5)
Missed 2/3 Pings --> ({Tolerant Ping:icmpping.avg(#3)}<0.5) and ({Tolerant Ping:icmpping.avg(#3)}>0)
Missed 3/3 Pings --> {Tolerant Ping:icmpping.avg(#3)}=0 


0 - пинг не проходит

1 1 0
1 0 0
0 0 0

max(#3)=0
{host:icmpping.max(90)}=0
за последние 90 секунд все ping не прошли.

Как только один пинг потерялся, то триггер сработает
min(#3)=0

https://www.zabbix.com/forum/in-russian/38424-%D0%97%D0%B0%D0%B4%D0%B5%D1%80%D0%B6%D0%BA%D0%B0-%D1%81-%D0%BF%D1%80%D0%B8%D1%85%D0%BE%D0%B4%D0%BE%D0%BC-%D1%83%D0%B2%D0%B5%D0%B4%D0%BE%D0%BC%D0%BB%D0%B5%D0%BD%D0%B8%D0%B9


Задержка с приходом уведомлений
07-08-2014, 12:46
Добрый день
Установил Zabbix 2.2.5 для мониторинга Windows хостов.
Настроил для начала следующий триггер
{HOST.NAME} is unavailable by ICMP
{Template ICMP Ping:icmpping.max(#3)}=0
Но проблема в том, что уведомление на почту приходит только спустя 2-3 минуты спустя как хост недоступен, то же самое и в панели мониторинга.

переделайте на
{Template ICMP Ping:icmpping.last()}=0
и создавайте тему "Как сделать что бы уведомления о потери пинга не приходили если сеть "моргнула" на пару секунд


Zentarim
А что вы, собственно, хотите? Вы написали триггер, который анализирует 3 последних значения элемента данных. Элемент данных у вас обновляется каждые 60 секунд. 60+60+60 - вот вам и 3 минуты. Через три минуты он у вас и срабатывает. Что хотели - то и получили.

Как вариант - поставьте обновление элемента данных раз в 10 секунд. Тогда у вас через 30 секунд триггер сработает. Если боитесь роста базы - уменьшите время хранения истории. Либо воспользуйтесь советом yukra, вот только его вариант будет срабатывать через минуту и действительно по каждому чиху












Причина обновления триггера состоит в том, что иногда может быть маленькая задержка в сети, в результате которой частично теряется ответ пингуемого сервера. Так на серию в 3 пинга (опция -с3) может прийти только два ответа echo-replay. В принципе получается,что канал доступен,конечно с некоторым ухудшением качества,а Zabbix воспринимает это как отсутствие канала и посылает уведомление.

В связи с этим необходимо привести триггер к виду:

{Router:icmpping.max(120)}<1

Это означает, что Zabbix пошлет уведомление о недоступности, если в течении 2 минут не придет ни одного echo-replay (цифра 120).

Опытным путем я также определил различные периоды времени для каждого типа сетевых устройств. Например,

маршрутизаторы должны проверяться в течении 2 минут, а для рабочих станций это время может быть увеличено до 5 минут. В этом случае простая перезагрузка рабочей станции, не зарегистрируется в системе мониторинга как проблема.

А проверку доступности свичей можно увеличить до 10 минут.

https://www.ekzorchik.ru/2015/09/check-the-remote-system-icmp-request/
